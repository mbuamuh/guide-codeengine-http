// Copyright (c) 2018, 2022 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//
:page-layout: guide-multipane
:projectid: codeengine-http
:page-duration: 20 minutes
:page-releasedate: 2023-01-10
:page-description: Learn how to create a system and an inventory serverless applications, using Jakarta Restful Web Services, Open Liberty, Docker and IBM Cloud Code Engine.
:page-tags: ['MicroProfile', 'Docker', 'Cloud']
:page-related-guides: ['rest-intro', 'docker']
:page-permalink: /guides/{projectid}
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:source-highlighter: prettify
:imagesdir: /img/guide/{codeengine-http}
:page-seo-title: Creating serverless functions in IBM Cloud Code Engine using MicroProfile applications
:page-seo-description: Find out how to create serverless functions in IBM Cloud Code Engine using MicroProfile applications
:guide-author: Open Liberty
= Creating serverless functions in IBM Cloud Code Engine using MicroProfile applications

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form,
view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Learn how to use MicroProfile applications to create serverless functions in IBM Cloud Code Engine.

:hashtag: #
:win: WINDOWS
:mac: MAC
:linux: LINUX
:system-api: https://systemapp.[xxxxxx].[cloud region].codeengine.appdomain.cloud
:inventory-api: https://inventoryapp.[xxxxxx].[cloud region].codeengine.appdomain.cloud

// =================================================================================================
// Introduction
// =================================================================================================

== What you'll learn

You will learn how to deploy two MicroProfile applications in Open Liberty containers, to IBM Cloud Container Registry and then to Code Engine, to run as serverless functions in IBM Cloud. You will also learn how to send and receive data from the developed serverless functions, using Http as the event source.

=== What is Serverless
Serverless is an entire stack of cloud services that can respond to specific events or requests, and scale to zero when no longer in use. With serverless provisioning, management and billing are handled by the cloud provider and invisible to developers. Developers focus on writing code and business logic, and not worry about infrastructure. Infrastructure tasks (for example provisioning, securing, scaling, scheduling, patching etc...), are the responsibilities of the cloud provider. The cloud provider spins up and provisions the required resources on demand when the code executes, and spins them down when execution stops. Developers or their companies do not have to pay for idle capacity. Pricing is based on execution time and resources required. To learn more about serverless, you can read the https://www.ibm.com/cloud/learn/serverless[What is Serverless] document.

=== What is IBM Cloud Code Engine
IBM Cloud Code Engine is a fully managed serverless platform, that runs your containerized workloads. This includes running web-apps, microservices, event driven functions, or batch jobs. Code engine can also build container images from your source code. Like any other serverless platform, code engine is designed such that developers can focus on writing code and not on infrastructure.


The two MicroProfile applications you will run as IBM Code Engine serverless functions, are called `system` and `inventory`. The `system` application returns JVM system properties of the running container. The `inventory` application queries properties from the `system` application, and adds them to its inventory list. It also queries its inventory list, to return the properties that were queried from the `system` application.

// =================================================================================================
// Prerequisites
// =================================================================================================

== Additional prerequisites

Before you begin, the following additional tools need to be installed:

* *Docker:* You need containerization software for building containers. IBM Cloud Code Engine supports Docker, so you will use Docker in this guide. For installation instructions, refer to the official https://docs.docker.com/install/[Docker^] documentation.

* *ibmcloud:* You need the IBM Cloud command-line tool `ibmcloud` to interact with your IBM Cloud account and its services. See the official https://cloud.ibm.com/docs/cli?topic=cli-getting-started[CLI Getting Started^] documentation, on how to install `ibmcloud`. +
To verify that the IBM Cloud CLI is installed correctly, run the following command:
+
[role=command]
```
ibmcloud help
```

* *ibmcloud cr:* You need the IBM Cloud Container Registry command-line tool plugin to set up your own image namespace in an IBM-hosted, and managed, private registry. You can store and share Docker images with all users in your IBM Cloud account from the registry. Refer to https://cloud.ibm.com/docs/cli?topic=cli-install-devtools-manually#idt-install-container-registry-cli-plugin[Installing IBM Cloud Container Registry CLI plug-in^], for installation instructions on how to install the plugin. +
To verify that the plugin is installed correctly, run the following command:
+
[role=command]
```
ibmcloud plugin show container-registry
```

* *ibmcloud ce:* You need the IBM Cloud Code Engine command-line tool plugin to access the Code Engine service in your IBM Cloud account. See the official documentation https://cloud.ibm.com/docs/codeengine?topic=codeengine-install-cli[Installing the Code Engine CLI plug-in^], on how to install the plugin. +
To verify that the plugin is installed correctly, run the following command:
+
[role=command]
```
ibmcloud plugin show code-engine
```

// =================================================================================================
// Getting Started
// =================================================================================================

[role='command']
include::{common-includes}/gitclone.adoc[]


== Granting IBM Cloud Code Engine project access to IBM Cloud Container Registry

Before you run the microprofile applications as serverless functions in IBM Cloud Code engine, you have to create a project, in which the containerized applications will run. To get the containerized applications from your local machine to the project, you have to deploy them to IBM Cloud Container Registry, and grant the created project access to the IBM Cloud Container Registry.


=== Creating an IBM Cloud API Key
Create an IBM Cloud API Key to be used by Ibm Cloud Code Engine to access images from Ibm Cloud Container Registry. It is recommended to create a different key for this purpose, so that the key is managed separately for its intended resources. Therefore, one can delete or update the key as they like, and will only need to change access for these resources, but will not need to change access to other resources which do not use this key.
----
ibmcloud iam api-key-create guideKey -d "Key to demo the open liberty serverless applications, using code engine" --file guideKey.txt
----
The api key will be stored in the `guideKey.txt` file. Save this file in a safe and protected location.

=== Creating an IBM Cloud Code Engine Project
Create an IBM Cloud Code Engine project to group the serverless functions, and thus be able to manage them and provide access to them.
----
ibmcloud ce project create --name guide-project
----
List code engine projects to check if the `guide-project` has been successfully created.
----
ibmcloud ce project list
----

=== Adding IBM Cloud Container Registry access to IBM Cloud Code Engine project
Change to the `guide-project` code engine project, to work within its context.
----
ibmcloud ce project select -n guide-project
----
Create an image registry secret, with which IBM Cloud code engine can access IBM Cloud container registry. In the command below, `<REGION>` can be for example `uk`, which is your location, and `XXXX` is the api key stored in the `guideKey.txt` file.
----
ibmcloud ce registry create --name guide-registry --server <REGION>.icr.io --username iamapikey --password XXXX
----


== Deploying microprofile applications to IBM Cloud Code Engine
In this section, you will learn how to deploy two microprofile applications in open liberty containers to IBM Cloud code engine. You will build and containerize the system and inventory applications, push them to IBM Cloud container registry, and then deploy them to your IBM Cloud code engine project.

=== Building and containerizing the applications
The first step of deploying to IBM Cloud code engine, is to build you microprofile applications and containerize them.

The starting Java project, which you can find in the `start` directory, is a multi-module Maven project. It is made up of the `system` and `inventory` applications. Each application resides in its own directory, start/guide-codeengine-http-system and start/guide-codeengine-http-inventory. Both of these directories contain a Dockerfile, which is necessary for building the Docker images. If youâ€™re unfamiliar with Dockerfiles, check out the https://openliberty.io/guides/containerize.html[Containerizing microservices^] guide.

To build these applications, navigate to the `start` directory and run the following command:

[role=command]
```
mvn package
```

Next, run the `docker build` commands to build the container images for your application:
[role='command']
```
docker build -t system:1.0-SNAPSHOT guide-codeengine-http-system/.
docker build -t inventory:1.0-SNAPSHOT guide-codeengine-http-inventory/.
```

The `-t` flag in the `docker build` command allows the Docker image to be labeled (tagged) in the `name[:tag]` format. The tag for an image describes the specific image version. If the optional `[:tag]` tag is not specified, the `latest` tag is created by default.

During the build, you see various Docker messages that describe what images are being downloaded and built. When the build finishes, run the following command to list all local Docker images:

[role=command]
```
docker images
```

Verify that the `system:1.0-SNAPSHOT` and `inventory:1.0-SNAPSHOT` images are listed among them, for example:

[source, role="no_copy"]
----
REPOSITORY                        TAG
system                            1.0-SNAPSHOT
inventory                         1.0-SNAPSHOT
icr.io/appcafe/open-liberty       kernel-slim-java11-openj9-ubi
----

If you don't see the `system:1.0-SNAPSHOT` and `inventory:1.0-SNAPSHOT` images, then check the Maven build log for any potential errors.

=== Pushing the images to IBM Cloud Container Registry
Pushing the images to a registry, facilitates their deployment to IBM Cloud code engine.

First, you must login to IBM Cloud container registry.
[role=command]
```
ibmcloud cr login
```
To ensure that you are targeting the right IBM Cloud container registry region, run the command below. `<YOUR_REGION>` is your cloud region, for example `uk-south`.
[role=command]
```
ibmcloud cr region-set <YOUR_REGION>
```
Next, create a namespace for your docker images:
[role=command]
```
ibmcloud cr namespace-add guide-namespace
```
Next, choose repositories and tags, by which you can identify the images. `<REGION>` is your country, for example `uk`.
[role='command']
```
docker tag system:1.0-SNAPSHOT <REGION>.icr.io/guide-namespace/system:1.0-SNAPSHOT
docker tag inventory:1.0-SNAPSHOT <REGION>.icr.io/guide-namespace/inventory:1.0-SNAPSHOT
```
Next, push the images to your private registry:
[role='command']
```
docker push <REGION>.icr.io/guide-namespace/system:1.0-SNAPSHOT
docker push <REGION>.icr.io/guide-namespace/inventory:1.0-SNAPSHOT
```
Finally, verify that your images are in your private registry:
[role=command]
```
ibmcloud cr image-list
```

=== Creating serverless applications in IBM Cloud Code Engine
This is the final step of deploying your containerized applications to IBM Cloud code engine.

Change to the project in IBM Cloud code engine, in which you want to create your serverless applications:
[role=command]
```
ibmcloud ce project select -n guide-project
```

Create serverless applications in IBM Cloud code engine from your images.
[role='command']
```
ibmcloud ce app create --name systemapp --image uk.icr.io/guide-namespace/system:1.0-SNAPSHOT --registry-secret guide-registry --port 9080
ibmcloud ce app create --name inventoryapp --image uk.icr.io/guide-namespace/inventory:1.0-SNAPSHOT --registry-secret guide-registry --port 9080
```

=== Making requests to the serverless applications
To make requests to the `systemapp` and `inventoryapp` serverless applications using `curl`, you have to get their urls.
[role='command']
```
ibmcloud ce app get --name systemapp --output url
ibmcloud ce app get --name inventoryapp --output url
```
The urls for systemsapp and invetoryapp, which will be returned will be in the format below, whereby you will substitute `xxxxx` and `cloud region`, by the values returned by `ibmcloud ce app get`

* `{system-api}`
* `{inventory-api}`

Next, execute the `GET` method on `systemapp` to get its container properties.
[role='command']
```
curl -X GET https://{system-api}/system/properties
```
Next, execute the `GET` method on `inventoryapp` to show that no properties from `systemapp` have been added to its inventory list.
[role='command']
```
curl -X GET https://{inventory-api}/inventory/systems
```
It returns an empty list
[source, role="no_copy"]
----
[]
----
Next, add the `systemapp` container properties `java.vendor.url`, and `wlp.install.dir` to the inventory list of `inventoryapp`.
[role='command']
```
curl -X POST https://{inventory-api}/inventory/systems/{system-api} -H "Ce-Specversion: 1.0" -H "Ce-Type: java.properties" -H "Ce-Source: io.cloudevents.examples/properties" -H "Ce-Id: properties" -H "Content-Type: application/json" -H "Ce-Subject: resources" -d "[\"java.vendor.url\",\"wlp.install.dir\"]"
```
Finally, retrieve the properties added to the `inventoryapp` inventory list:
[role='command']
```
curl -X GET https://{inventory-api}/inventory/systems
```

// =================================================================================================
// Tear Down
// =================================================================================================


== Tearing down the environment


// =================================================================================================
// finish
// =================================================================================================

== Great work! You're done!

You just deployed two microservices to IBM Cloud. You also learned how to use the `kubectl` command to deploy your microservices on a {kube} cluster.

// Multipane
include::{common-includes}/attribution.adoc[subs="attributes"]

// DO NO CREATE ANYMORE SECTIONS AT THIS POINT
// Related guides will be added in automatically here if you included them in ":page-related-guides"
